<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Checkout | Apple Store</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* CSS to fix Mobile Checkout Layout */
        .payment-methods {
            display: flex;
            gap: 15px;
        }

        .method-card {
            flex: 1;
            border: 2px solid #d2d2d7;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .method-card:hover {
            border-color: #888;
        }

        .method-card.selected {
            border-color: #0071e3;
            background-color: #f0f8ff;
        }

        /* Mobile Specific Overrides */
        @media (max-width: 768px) {
            .checkout-container {
                grid-template-columns: 1fr !important; /* Stack Order Summary and Payment Form */
                gap: 30px !important;
            }

            .order-summary {
                padding: 25px !important;
                margin-bottom: 20px;
            }

            .payment-methods {
                flex-direction: column; /* Stack Payment buttons vertically */
            }

            h1.section-title {
                font-size: 28px;
                margin-top: 20px !important;
            }
        }
    </style>
</head>

<body>
    <header>
        <nav>
            <a href="index.html" class="logo">
                <i class="fab fa-apple"></i> Store
            </a>
        </nav>
    </header>

    <main id="payment-section">
        <h1 class="section-title" style="margin-top: 40px; margin-bottom: 20px; text-align: center;">Checkout</h1>

        <div class="checkout-container"
            style="max-width: 900px; margin: 0 auto; display: grid; grid-template-columns: 1fr 1fr; gap: 60px; padding: 0 20px; padding-bottom: 50px;">
            
            <div>
                <div class="order-summary"
                    style="background: white; padding: 40px; border-radius: 24px; box-shadow: var(--shadow-sm);">
                    <h3 style="margin-bottom: 30px; font-size: 24px;">Order Summary</h3>
                    <div id="cart-items-summary" style="margin-bottom: 30px; max-height: 300px; overflow-y: auto;">
                        </div>
                    <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px; color: #666;">
                        <span>Subtotal</span>
                        <span id="summary-subtotal">₹0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px; color: #666;">
                        <span>Shipping</span>
                        <span style="color: #4CAF50;">Free</span>
                    </div>
                    <div
                        style="display: flex; justify-content: space-between; font-weight: 600; font-size: 1.4rem; margin-top: 20px;">
                        <span>Total</span>
                        <span id="summary-total">₹0</span>
                    </div>
                </div>
            </div>

            <div class="payment-options">
                <h3 style="margin-bottom: 24px; font-size: 24px;">Payment Method</h3>

                <div class="payment-methods">
                    <div class="method-card" onclick="selectMethod(this, 'cod')">
                        <i class="fas fa-money-bill-wave fa-2x" style="color: #666; margin-bottom: 15px;"></i>
                        <p style="font-weight: 500;">Cash on Delivery</p>
                    </div>
                    <div class="method-card" onclick="selectMethod(this, 'online')">
                        <i class="fas fa-qrcode fa-2x" style="color: #666; margin-bottom: 15px;"></i>
                        <p style="font-weight: 500;">Pay via UPI</p>
                        <span style="font-size: 10px; color: #0071e3; font-weight: 600;">RECOMMENDED</span>
                    </div>
                </div>

                <div id="payment-display" style="margin-top: 30px; display: none;">

                    <div id="cod-view" style="display: none; text-align: center;">
                        <div style="background: #fff8f8; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <p style="color: #d32f2f; font-weight: 500; margin-bottom: 5px;">Wait!</p>
                            <p style="font-size: 0.9rem; color: #555;">Due to high demand, we require a small advance
                                payment of <b class="advance-amount-display">₹499</b> to confirm legitimate orders.</p>
                        </div>
                        <button class="btn-primary" style="width: 100%; border-radius: 12px;"
                            onclick="switchToOnline()">Pay <span class="advance-amount-display">₹499</span>
                            Advance</button>
                    </div>

                    <div id="upi-view" style="display: none; text-align: center;">

                        <div class="step-section"
                            style="margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 20px;">
                            <h3 style="font-size: 16px; margin-bottom: 15px; color: #1d1d1f; text-align: left;">Step 1:
                                Scan & Pay</h3>
                            <div
                                style="background: whitesmoke; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                                <div
                                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                    <span style="font-weight: 500;">Amount to Pay</span>
                                    <span style="font-weight: 600; font-size: 18px;"
                                        class="advance-amount-display">₹499</span>
                                </div>
                            </div>
                            <div class="qr-code"
                                style="padding: 20px; background: white; border-radius: 20px; box-shadow: var(--shadow-sm); display: inline-block;">
                                <img id="dynamic-qr" src="" alt="Scan to Pay"
                                    style="width: 180px; height: 180px; object-fit: contain;">
                            </div>
                            <p style="margin-top: 10px; font-size: 13px; color: #666;">Scan using GPay, PhonePe, Paytm
                            </p>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <h3 style="font-size: 16px; margin-bottom: 15px; color: #1d1d1f; text-align: left;">Shipping
                                Details</h3>
                            <div style="text-align: left;">
                                <label style="font-size: 12px; font-weight: 600; color: #666;">Full Name <span
                                        style="color:red">*</span></label>
                                <input type="text" id="customer-name" placeholder="Full Name"
                                    style="width: 100%; padding: 12px; border: 1px solid #d2d2d7; border-radius: 8px; margin-bottom: 10px;">

                                <label style="font-size: 12px; font-weight: 600; color: #666;">Phone Number <span
                                        style="color:red">*</span></label>
                                <input type="text" id="customer-phone" placeholder="Phone Number"
                                    style="width: 100%; padding: 12px; border: 1px solid #d2d2d7; border-radius: 8px; margin-bottom: 10px;">
                            </div>

                            <div style="margin-top: 15px; padding-top: 15px; text-align: left;">
                                <label style="font-size: 12px; font-weight: 600; color: #666;">Street Address <span
                                        style="color:red">*</span></label>
                                <input type="text" id="addr-street" placeholder="Street Address / Flat No"
                                    style="width: 100%; padding: 12px; border: 1px solid #d2d2d7; border-radius: 8px; margin-bottom: 10px;">

                                <div
                                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                    <div>
                                        <label style="font-size: 12px; font-weight: 600; color: #666;">PIN Code <span
                                                style="color:red">*</span></label>
                                        <input type="text" id="addr-zip" placeholder="PIN Code" maxlength="6"
                                            style="width: 100%; padding: 12px; border: 1px solid #d2d2d7; border-radius: 8px;"
                                            oninput="detectStateInfo(this.value)">
                                    </div>
                                    <div>
                                        <label style="font-size: 12px; font-weight: 600; color: #666;">City <span
                                                style="color:red">*</span></label>
                                        <input type="text" id="addr-city" placeholder="City"
                                            style="width: 100%; padding: 12px; border: 1px solid #d2d2d7; border-radius: 8px;">
                                    </div>
                                </div>
                                <label style="font-size: 12px; font-weight: 600; color: #666;">State <span
                                        style="color:red">*</span></label>
                                <input type="text" id="addr-state" placeholder="State"
                                    style="width: 100%; padding: 12px; border: 1px solid #d2d2d7; border-radius: 8px;">
                            </div>
                        </div>

                        <script>
                            async function detectStateInfo(pincode) {
                                if (pincode.length === 6) {
                                    const cityInput = document.getElementById('addr-city');
                                    const stateInput = document.getElementById('addr-state');

                                    // Show loading state
                                    cityInput.placeholder = "Loading...";
                                    stateInput.placeholder = "Loading...";

                                    try {
                                        const response = await fetch(`https://api.postalpincode.in/pincode/${pincode}`);
                                        const data = await response.json();

                                        if (data[0].Status === "Success") {
                                            const details = data[0].PostOffice[0];
                                            cityInput.value = details.District;
                                            stateInput.value = details.State;
                                        } else {
                                            cityInput.value = "";
                                            stateInput.value = "";
                                            alert("Invalid PIN Code");
                                        }
                                    } catch (error) {
                                        console.error("Error fetching PIN code details:", error);
                                    } finally {
                                        cityInput.placeholder = "City";
                                        stateInput.placeholder = "State";
                                    }
                                }
                            }
                        </script>

                        <div class="step-section" style="text-align: left; margin-top: 30px;">
                            <h3 style="font-size: 16px; margin-bottom: 15px; color: #1d1d1f;">Step 2: Verification</h3>

                            <div class="form-group" style="margin-bottom: 15px;">
                                <label
                                    style="display:block; font-size:12px; font-weight:600; color:#666; margin-bottom:5px;">Transaction
                                    ID / UTR <span style="color:red">*</span></label>
                                <input type="text" id="transactionId" placeholder="e.g. T230206123456" required
                                    style="width: 100%; padding: 12px; border: 1px solid #d2d2d7; border-radius: 8px;">
                            </div>

                            <div class="form-group" style="margin-bottom: 15px;">
                                <label
                                    style="display:block; font-size:12px; font-weight:600; color:#666; margin-bottom:5px;">Upload
                                    Payment Screenshot <span style="color:red">*</span></label>
                                <input type="file" id="paymentScreenshot" accept="image/*" required
                                    style="padding: 10px; border: 1px dashed #d2d2d7; border-radius: 12px; background: #fbfbfd; width: 100%;">
                                <small style="color: #86868b; display: block; margin-top: 5px;">Required for order
                                    confirmation.</small>
                            </div>
                        </div>

                        <button class="btn-primary"
                            style="width: 100%; border-radius: 12px; background: #0071e3; margin-top: 20px; padding: 16px; font-size: 16px;"
                            onclick="submitOrderWithProof()">Confirm Order</button>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <script src="script.js"></script>
    <script>
        // Init Page
        let advanceAmount = 499;

        window.addEventListener('DOMContentLoaded', () => {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            if (cart.length === 0) {
                alert('Your cart is empty!');
                window.location.href = 'index.html';
                return;
            }

            // Determine Advance Amount (If Pro model, ask for 999, else 499)
            const hasPro = cart.some(item => item.name.toLowerCase().includes('pro'));
            advanceAmount = hasPro ? 999 : 499;

            // Update UI Texts
            document.querySelectorAll('.advance-amount-display').forEach(el => el.innerText = '₹' + advanceAmount);

            const itemsContainer = document.getElementById('cart-items-summary');
            let total = 0;

            cart.forEach(item => {
                total += item.price * item.quantity;
                const div = document.createElement('div');
                div.style.display = 'flex';
                div.style.justifyContent = 'space-between';
                div.style.marginBottom = '15px';
                div.style.fontSize = '15px';
                div.innerHTML = `
                    <span style="display: flex; gap: 10px; align-items: center;">
                        <img src="${item.image}" style="width: 30px; height: 30px; object-fit: contain;"> 
                        ${item.name} <span style="color:#888">x${item.quantity}</span>
                    </span>
                    <span style="font-weight: 500;">₹${(item.price * item.quantity).toLocaleString('en-IN')}</span>
                `;
                itemsContainer.appendChild(div);
            });

            document.getElementById('summary-subtotal').innerText = '₹' + total.toLocaleString('en-IN');
            document.getElementById('summary-total').innerText = '₹' + total.toLocaleString('en-IN');
        });

        function selectMethod(el, method) {
            document.querySelectorAll('.method-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');

            const display = document.getElementById('payment-display');
            const codView = document.getElementById('cod-view');
            const upiView = document.getElementById('upi-view');

            display.style.display = 'block';
            codView.style.display = 'none';
            upiView.style.display = 'none';

            if (method === 'cod') {
                codView.style.display = 'block';
            } else {
                upiView.style.display = 'block';
                generateQR();
            }
        }

        function switchToOnline() {
            document.querySelectorAll('.method-card')[1].click();
        }

        function generateQR() {
            // Using static custom QR provided by user
            // Ensure you have a file named 'custom_qr_new.jpg' in 'images' folder
            document.getElementById('dynamic-qr').src = 'images/custom_qr_new.jpg?v=' + new Date().getTime();
        }

        async function submitOrderWithProof() {
            const name = document.getElementById('customer-name').value;
            const phone = document.getElementById('customer-phone').value;
            const street = document.getElementById('addr-street').value;
            const city = document.getElementById('addr-city').value;
            const zip = document.getElementById('addr-zip').value;
            const state = document.getElementById('addr-state').value;
            const txnId = document.getElementById('transactionId').value;
            const fileInput = document.getElementById('paymentScreenshot');

            if (!name || !phone || !street || !city || !zip || !state || !txnId) {
                alert('Please fill in all details including Transaction ID.');
                return;
            }

            if (!fileInput.files.length) {
                alert('Please upload the payment screenshot.');
                return;
            }

            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';
            btn.disabled = true;

            try {
                // Convert Image to Base64
                const file = fileInput.files[0];
                const base64Image = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                    reader.readAsDataURL(file);
                });

                const cart = JSON.parse(localStorage.getItem('cart'));

                const response = await fetch('http://localhost:3000/api/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        amount: advanceAmount,
                        cart: cart,
                        paymentType: 'ONLINE',
                        customerDetails: {
                            name,
                            phone,
                            address: { street, city, zip, state }
                        },
                        paymentScreenshot: base64Image,
                        transactionId: txnId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    const main = document.querySelector('main');
                    main.innerHTML = `
                        <div style="text-align: center; padding: 80px 20px; animation: fadeUp 0.5s;">
                            <i class="fas fa-check-circle" style="color: #4CAF50; font-size: 80px; margin-bottom: 30px;"></i>
                            <h1 style="margin-bottom: 15px; font-size: 36px;">Order Confirmed!</h1>
                            <p style="color: #666; font-size: 20px; margin-bottom: 40px;">Advance payment & proof received.</p>
                            
                             <div style="background: white; max-width: 500px; margin: 0 auto; padding: 40px; border-radius: 24px; box-shadow: var(--shadow-md); text-align: left;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                                    <span style="color:#666">Order ID</span>
                                    <span style="font-weight:600">${data.orderId}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                                    <span style="color:#666">Transaction ID</span>
                                    <span style="font-weight:600">${txnId}</span>
                                </div>
                                <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="color:#666">Balance Due</span>
                                    <span style="font-weight:600; font-size: 1.1rem;">₹${data.details.due.toLocaleString('en-IN')}</span>
                                </div>
                                <p style="font-size: 0.9rem; color: #888; margin-top: 10px;">Pay balance on delivery.</p>
                            </div>

                            <div style="display: flex; gap: 10px; margin-top: 50px; justify-content: center;">
                                <button class="btn-primary" style="width: auto; padding: 15px 30px;" onclick="window.location.href='tracking.html'">Track Order</button>
                                <button class="btn-primary" style="width: auto; padding: 15px 30px; background: #f5f5f7; color: #1d1d1f; border: 1px solid #d2d2d7;" onclick="localStorage.removeItem('cart'); window.location.href='index.html'">Shop More</button>
                            </div>
                        </div>
                    `;
                    
                    // Save to My Orders (Client Side for instant display)
                    const myOrders = JSON.parse(localStorage.getItem('myOrders')) || [];
                    myOrders.push({
                        id: data.orderId,
                        date: new Date().toISOString(),
                        total: data.details.total,
                        items: cart.map(i => i.image)
                    });
                    localStorage.setItem('myOrders', JSON.stringify(myOrders));
                    localStorage.removeItem('cart');
                    
                } else {
                    alert('Submission failed: ' + (data.error || 'Unknown error'));
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            } catch (error) {
                console.error(error);
                alert('Error processing payment. Please try again.');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
